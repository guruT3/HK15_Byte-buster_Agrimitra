{% extends "base.html" %}
{% block title %}Farm Action Plan{% endblock %}
{% block content %}

<style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Hind:wght@300;400;500;600&display=swap');

    :root {
        --soil:    #4a2c0a;
        --bark:    #6b3f1a;
        --hay:     #c8a84b;
        --sun:     #f5c842;
        --leaf:    #2d7a3a;
        --sprout:  #4caf50;
        --sky:     #e8f5e9;
        --cream:   #fdf9ef;
        --red:     #c0392b;
        --orange:  #e67e22;
        --blue:    #2980b9;
        --shadow:  rgba(74,44,10,0.12);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: 'Hind', sans-serif;
        background: var(--cream);
        color: #2c3e50;
    }

    /* ‚îÄ‚îÄ PAGE HERO ‚îÄ‚îÄ */
    .plan-hero {
        background: linear-gradient(135deg, var(--soil) 0%, var(--leaf) 100%);
        padding: 48px 32px 64px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .plan-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .plan-hero h1 {
        font-family: 'Baloo 2', cursive;
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 800;
        color: #fff;
        position: relative;
    }

    .plan-hero h1 span { color: var(--sun); }

    .plan-hero p {
        color: rgba(255,255,255,0.82);
        margin-top: 10px;
        font-size: 1.05rem;
        position: relative;
    }

    /* ‚îÄ‚îÄ STEPS INDICATOR ‚îÄ‚îÄ */
    .steps-bar {
        background: #fff;
        border-bottom: 2px solid #e8e0d0;
        padding: 0;
        display: flex;
        justify-content: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 12px var(--shadow);
    }

    .step-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 16px 28px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.25s;
        font-weight: 600;
        color: #aaa;
        font-size: 0.9rem;
    }

    .step-item.active {
        color: var(--leaf);
        border-bottom-color: var(--leaf);
    }

    .step-item.done {
        color: var(--sprout);
    }

    .step-num {
        width: 28px; height: 28px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #888;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.85rem;
        font-weight: 700;
        transition: all 0.25s;
        flex-shrink: 0;
    }

    .step-item.active .step-num { background: var(--leaf); color: #fff; }
    .step-item.done .step-num   { background: var(--sprout); color: #fff; }

    /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
    .plan-main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 40px 20px 80px;
    }

    /* ‚îÄ‚îÄ WIZARD PANELS ‚îÄ‚îÄ */
    .wizard-panel { display: none; animation: fadeSlide 0.4s ease; }
    .wizard-panel.active { display: block; }

    @keyframes fadeSlide {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card {
        background: #fff;
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 4px 24px var(--shadow);
        border: 1.5px solid #f0e8d8;
    }

    .card-title {
        font-family: 'Baloo 2', cursive;
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--soil);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-title .icon {
        width: 40px; height: 40px;
        border-radius: 12px;
        background: var(--sky);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }

    /* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
    }

    .field { display: flex; flex-direction: column; gap: 8px; }

    .field label {
        font-weight: 600;
        font-size: 0.88rem;
        color: var(--bark);
        letter-spacing: 0.3px;
    }

    .field input,
    .field select {
        padding: 13px 16px;
        border: 2px solid #e0d8c8;
        border-radius: 12px;
        font-family: 'Hind', sans-serif;
        font-size: 0.95rem;
        color: #2c3e50;
        background: var(--cream);
        transition: border-color 0.2s, box-shadow 0.2s;
        outline: none;
    }

    .field input:focus,
    .field select:focus {
        border-color: var(--sprout);
        box-shadow: 0 0 0 3px rgba(76,175,80,0.12);
        background: #fff;
    }

    .field.full { grid-column: 1 / -1; }

    /* ‚îÄ‚îÄ SLIDERS ‚îÄ‚îÄ */
    .slider-group { margin-bottom: 28px; }

    .slider-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .slider-label-row .name { font-weight: 600; font-size: 0.95rem; color: var(--soil); }

    .slider-badge { padding: 4px 14px; border-radius: 100px; font-size: 0.85rem; font-weight: 700; }
    .badge-low    { background: #e8f5e9; color: var(--leaf); }
    .badge-medium { background: #fff3e0; color: var(--orange); }
    .badge-high   { background: #fdecea; color: var(--red); }

    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        height: 10px;
        border-radius: 100px;
        background: #e0d8c8;
        outline: none;
        cursor: pointer;
    }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 26px; height: 26px;
        border-radius: 50%;
        background: var(--leaf);
        border: 3px solid #fff;
        box-shadow: 0 2px 8px rgba(45,122,58,0.4);
        cursor: pointer;
        transition: transform 0.15s;
    }

    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

    .slider-hints {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #aaa;
        margin-top: 5px;
    }

    /* ‚îÄ‚îÄ WEATHER GRID ‚îÄ‚îÄ */
    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .location-row { display: flex; gap: 10px; align-items: center; }

    .location-row input {
        padding: 10px 16px;
        border: 2px solid #e0d8c8;
        border-radius: 10px;
        font-family: 'Hind', sans-serif;
        font-size: 0.9rem;
        outline: none;
        background: var(--cream);
        width: 180px;
    }

    .btn-fetch {
        padding: 10px 20px;
        background: var(--leaf);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.2s, transform 0.15s;
    }

    .btn-fetch:hover { background: var(--soil); transform: translateY(-1px); }

    .weather-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
    }

    .w-day {
        background: var(--sky);
        border-radius: 14px;
        padding: 14px 8px;
        text-align: center;
        border: 2px solid #c8e6c9;
        transition: border-color 0.2s;
    }

    .w-day:hover { border-color: var(--sprout); }
    .w-day .day-name { font-family: 'Baloo 2', cursive; font-weight: 700; font-size: 0.85rem; color: var(--leaf); margin-bottom: 10px; }
    .w-day .w-icon  { font-size: 1.4rem; margin-bottom: 8px; }

    .w-day input {
        width: 100%;
        padding: 6px 4px;
        border: 1.5px solid #b2dfdb;
        border-radius: 8px;
        text-align: center;
        font-size: 0.82rem;
        background: #fff;
        margin-bottom: 5px;
        outline: none;
        color: #2c3e50;
    }

    .w-day input:focus { border-color: var(--sprout); }
    .w-day .w-label { font-size: 0.68rem; color: #78909c; font-weight: 500; margin-bottom: 3px; }

    /* ‚îÄ‚îÄ NAV BUTTONS ‚îÄ‚îÄ */
    .nav-row { display: flex; justify-content: space-between; margin-top: 32px; gap: 16px; }

    .btn-back {
        padding: 14px 32px;
        background: none;
        border: 2px solid #c8b89a;
        border-radius: 14px;
        color: var(--bark);
        font-family: 'Baloo 2', cursive;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-back:hover { background: #f5ece0; }

    .btn-next {
        flex: 1;
        padding: 16px 32px;
        background: linear-gradient(135deg, var(--leaf), #1b5e20);
        color: #fff;
        border: none;
        border-radius: 14px;
        font-family: 'Baloo 2', cursive;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 6px 20px rgba(45,122,58,0.3);
    }

    .btn-next:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(45,122,58,0.4); }
    .btn-next:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-generate {
        flex: 1;
        padding: 18px 32px;
        background: linear-gradient(135deg, var(--hay), #a07830);
        color: #fff;
        border: none;
        border-radius: 14px;
        font-family: 'Baloo 2', cursive;
        font-size: 1.1rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 6px 20px rgba(168,120,48,0.35);
        letter-spacing: 0.3px;
    }

    .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(168,120,48,0.45); }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .loading-screen { display: none; text-align: center; padding: 60px 20px; }
    .loading-screen.show { display: block; }

    .field-anim {
        font-size: 4rem;
        animation: grow 1.5s ease-in-out infinite alternate;
        display: block;
        margin-bottom: 20px;
    }

    @keyframes grow {
        from { transform: scale(0.9); opacity: 0.7; }
        to   { transform: scale(1.1); opacity: 1; }
    }

    .loading-screen h3 { font-family: 'Baloo 2', cursive; font-size: 1.5rem; color: var(--leaf); margin-bottom: 8px; }
    .loading-screen p  { color: #888; }

    .progress-bar {
        width: 280px;
        height: 8px;
        background: #e0d8c8;
        border-radius: 100px;
        margin: 20px auto 0;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--sprout), var(--hay));
        border-radius: 100px;
        animation: load 2.5s ease-in-out infinite;
    }

    @keyframes load {
        0%   { width: 0%; }
        60%  { width: 85%; }
        100% { width: 95%; }
    }

    /* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
    .results-panel { display: none; }
    .results-panel.show { display: block; animation: fadeSlide 0.5s ease; }

    .farm-summary-card {
        background: linear-gradient(135deg, var(--soil), var(--leaf));
        color: #fff;
        border-radius: 20px;
        padding: 28px 32px;
        margin-bottom: 28px;
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        align-items: center;
        justify-content: space-between;
    }

    .summary-stat .s-label { font-size: 0.75rem; letter-spacing: 1.5px; text-transform: uppercase; opacity: 0.75; margin-bottom: 4px; }
    .summary-stat .s-val   { font-family: 'Baloo 2', cursive; font-size: 1.3rem; font-weight: 700; }

    .result-section { margin-bottom: 36px; }

    .result-section-title {
        font-family: 'Baloo 2', cursive;
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--soil);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2.5px dashed #d4c9a8;
    }

    /* ‚îÄ‚îÄ TASK CARDS ‚îÄ‚îÄ */
    .task-card {
        background: #fff;
        border-radius: 16px;
        padding: 22px 24px;
        margin-bottom: 14px;
        border-left: 5px solid var(--sprout);
        box-shadow: 0 3px 16px var(--shadow);
        transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s;
        position: relative;
        overflow: hidden;
    }

    .task-card::before {
        content: '';
        position: absolute;
        top: 0; right: 0;
        width: 80px; height: 80px;
        border-radius: 0 0 0 80px;
        opacity: 0.06;
    }

    .task-card:hover { transform: translateX(6px); box-shadow: 0 6px 24px var(--shadow); }

    .task-card.high   { border-left-color: var(--red);    background: #fff8f7; }
    .task-card.high::before   { background: var(--red); }
    .task-card.medium { border-left-color: var(--orange); background: #fffaf4; }
    .task-card.medium::before { background: var(--orange); }
    .task-card.low    { border-left-color: var(--blue);   background: #f4f9ff; }
    .task-card.low::before    { background: var(--blue); }

    /* Completed state */
    .task-card.completed {
        opacity: 0.65;
        border-left-color: var(--sprout) !important;
        background: #f0faf0 !important;
    }

    .task-card.completed .task-name {
        text-decoration: line-through;
        color: #888;
    }

    .task-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        gap: 12px;
    }

    /* ‚îÄ‚îÄ CHECKBOX ‚îÄ‚îÄ */
    .task-checkbox-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }

    .task-checkbox {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 2.5px solid #ccc;
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    .task-checkbox:hover {
        border-color: var(--sprout);
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(76,175,80,0.15);
    }

    .task-checkbox.checked {
        background: var(--sprout);
        border-color: var(--sprout);
        animation: checkPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }

    @keyframes checkPop {
        0%   { transform: scale(0.7); }
        60%  { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .task-checkbox .check-icon {
        color: #fff;
        font-size: 1rem;
        opacity: 0;
        transition: opacity 0.2s;
        font-weight: 900;
    }

    .task-checkbox.checked .check-icon { opacity: 1; }

    .task-name { font-family: 'Baloo 2', cursive; font-size: 1.05rem; font-weight: 700; color: var(--soil); flex: 1; transition: all 0.3s; }

    .priority-pill {
        padding: 5px 14px;
        border-radius: 100px;
        font-size: 0.78rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .pill-high   { background: #fdecea; color: var(--red); }
    .pill-medium { background: #fff3e0; color: var(--orange); }
    .pill-low    { background: #e3f2fd; color: var(--blue); }

    .task-meta { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 10px; }
    .task-meta span { font-size: 0.83rem; color: #90a4ae; display: flex; align-items: center; gap: 4px; }

    .task-reason { font-size: 0.92rem; color: #546e7a; line-height: 1.6; margin-bottom: 10px; }

    .task-risk {
        background: #fffde7;
        border-left: 3px solid var(--hay);
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #7c5c00;
        line-height: 1.5;
    }

    .no-tasks {
        text-align: center;
        padding: 40px;
        color: var(--sprout);
        font-family: 'Baloo 2', cursive;
        font-size: 1.1rem;
        background: var(--sky);
        border-radius: 16px;
        border: 2px dashed #a5d6a7;
    }

    /* ‚îÄ‚îÄ PROGRESS DASHBOARD ‚îÄ‚îÄ */
    .progress-dashboard {
        background: #fff;
        border-radius: 20px;
        padding: 28px 32px;
        margin-bottom: 28px;
        box-shadow: 0 4px 24px var(--shadow);
        border: 1.5px solid #f0e8d8;
    }

    .progress-dashboard-title {
        font-family: 'Baloo 2', cursive;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--soil);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-stats-row {
        display: flex;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .p-stat {
        flex: 1;
        min-width: 100px;
        background: var(--sky);
        border-radius: 14px;
        padding: 16px;
        text-align: center;
        border: 1.5px solid #c8e6c9;
    }

    .p-stat .p-num {
        font-family: 'Baloo 2', cursive;
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 4px;
    }

    .p-stat .p-label {
        font-size: 0.78rem;
        color: #78909c;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .p-stat.done-stat .p-num { color: var(--sprout); }
    .p-stat.pending-stat .p-num { color: var(--orange); }
    .p-stat.pct-stat .p-num { color: var(--leaf); }

    /* Linear progress bar */
    .overall-bar-wrap {
        margin-bottom: 24px;
    }

    .overall-bar-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--bark);
        margin-bottom: 8px;
    }

    .overall-bar-track {
        height: 18px;
        background: #e0d8c8;
        border-radius: 100px;
        overflow: hidden;
        position: relative;
    }

    .overall-bar-fill {
        height: 100%;
        border-radius: 100px;
        background: linear-gradient(90deg, var(--sprout), var(--sun));
        transition: width 0.6s cubic-bezier(0.34,1.2,0.64,1);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
    }

    .overall-bar-fill span {
        font-size: 0.72rem;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
    }

    /* Segmented bars per category */
    .category-bars { display: flex; flex-direction: column; gap: 12px; }

    .cat-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .cat-row .cat-label {
        width: 90px;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--bark);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .cat-row .cat-track {
        flex: 1;
        height: 12px;
        background: #f0e8d8;
        border-radius: 100px;
        overflow: hidden;
    }

    .cat-row .cat-fill {
        height: 100%;
        border-radius: 100px;
        transition: width 0.6s cubic-bezier(0.34,1.2,0.64,1);
    }

    .cat-fill.fill-high   { background: linear-gradient(90deg, #e74c3c, #c0392b); }
    .cat-fill.fill-medium { background: linear-gradient(90deg, #f39c12, #e67e22); }
    .cat-fill.fill-low    { background: linear-gradient(90deg, #3498db, #2980b9); }

    .cat-row .cat-count {
        width: 50px;
        font-size: 0.78rem;
        color: #90a4ae;
        text-align: right;
        flex-shrink: 0;
    }

    /* Donut chart */
    .chart-row {
        display: flex;
        gap: 28px;
        align-items: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .donut-wrap {
        position: relative;
        width: 140px;
        height: 140px;
        flex-shrink: 0;
    }

    .donut-svg { width: 100%; height: 100%; transform: rotate(-90deg); }

    .donut-track { fill: none; stroke: #e0d8c8; stroke-width: 18; }
    .donut-fill  { fill: none; stroke: var(--sprout); stroke-width: 18; stroke-linecap: round; transition: stroke-dashoffset 0.8s cubic-bezier(0.34,1.2,0.64,1); }

    .donut-text {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .donut-pct {
        font-family: 'Baloo 2', cursive;
        font-size: 1.6rem;
        font-weight: 800;
        color: var(--leaf);
        line-height: 1;
    }

    .donut-sub { font-size: 0.72rem; color: #90a4ae; font-weight: 600; }

    .legend-list { display: flex; flex-direction: column; gap: 10px; flex: 1; }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.88rem;
    }

    .legend-dot {
        width: 12px; height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .legend-dot.done    { background: var(--sprout); }
    .legend-dot.pending { background: #e0d8c8; }

    .legend-label { flex: 1; color: var(--bark); font-weight: 600; }
    .legend-val   { font-family: 'Baloo 2', cursive; font-weight: 700; color: var(--soil); }

    /* ‚îÄ‚îÄ EXPORT BUTTON ‚îÄ‚îÄ */
    .btn-export {
        width: 100%;
        padding: 16px;
        margin-top: 32px;
        background: linear-gradient(135deg, #2980b9, #1a5276);
        color: #fff;
        border: none;
        border-radius: 14px;
        font-family: 'Baloo 2', cursive;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-export:hover { opacity: 0.9; transform: translateY(-1px); }

    .btn-reset {
        width: 100%;
        padding: 16px;
        margin-top: 12px;
        background: none;
        border: 2.5px solid var(--leaf);
        color: var(--leaf);
        border-radius: 14px;
        font-family: 'Baloo 2', cursive;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-reset:hover { background: var(--sky); }

    .fetch-status { font-size: 0.85rem; color: var(--sprout); display: none; align-items: center; gap: 6px; }
    .fetch-status.show { display: flex; }

    /* Confetti particle (when all done) */
    @keyframes confettiFall {
        0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
        100% { transform: translateY(80px) rotate(360deg); opacity: 0; }
    }

    .confetti-particle {
        position: fixed;
        width: 10px; height: 10px;
        border-radius: 2px;
        pointer-events: none;
        animation: confettiFall 1.2s ease-out forwards;
        z-index: 9999;
    }

    /* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
    @media print {
        .steps-bar,
        .plan-hero,
        .btn-export,
        .btn-reset,
        .nav-row,
        .loading-screen { display: none !important; }

        body { background: #fff; }
        .plan-main { padding: 0; max-width: 100%; }
        .wizard-panel { display: none !important; }
        #panel-4 { display: block !important; }
        .results-panel { display: block !important; }
        .card, .task-card { box-shadow: none !important; border: 1px solid #ddd; }
        .farm-summary-card { background: #2d7a3a !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .task-card.high   { background: #fff8f7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .task-card.medium { background: #fffaf4 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .task-card.low    { background: #f4f9ff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .task-risk { background: #fffde7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .task-card { break-inside: avoid; page-break-inside: avoid; }
        .result-section { break-inside: avoid; page-break-inside: avoid; }
        @page { margin: 1.5cm; size: A4; }
    }

    @media (max-width: 760px) {
        .weather-days { grid-template-columns: repeat(4, 1fr); }
        .steps-bar { overflow-x: auto; }
        .step-item { padding: 14px 16px; font-size: 0.8rem; }
        .farm-summary-card { flex-direction: column; text-align: center; }
        .chart-row { flex-direction: column; }
        .donut-wrap { margin: 0 auto; }
    }

    @media (max-width: 480px) {
        .weather-days { grid-template-columns: repeat(2, 1fr); }
        .card { padding: 20px; }
    }
</style>

<!-- HERO -->
<div class="plan-hero">
    <h1>üåæ Farm Action <span>Planner</span></h1>
    <p>Tell us about your farm ‚Äî we'll build your smart 7-day plan</p>
</div>

<!-- STEP INDICATOR -->
<div class="steps-bar">
    <div class="step-item active" id="step-tab-1" onclick="goToStep(1)">
        <div class="step-num">1</div> Farm Details
    </div>
    <div class="step-item" id="step-tab-2" onclick="goToStep(2)">
        <div class="step-num">2</div> ML Scores
    </div>
    <div class="step-item" id="step-tab-3" onclick="goToStep(3)">
        <div class="step-num">3</div> Weather
    </div>
    <div class="step-item" id="step-tab-4" onclick="goToStep(4)">
        <div class="step-num">4</div> Your Plan
    </div>
</div>

<div class="plan-main">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 1 ‚Äî FARM DETAILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="wizard-panel active" id="panel-1">
        <div class="card">
            <div class="card-title"><div class="icon">üå±</div> What are you growing?</div>
            <div class="form-grid">
                <div class="field">
                    <label>Crop Type</label>
                    <input type="text" id="cropType" placeholder="e.g. Wheat, Rice, Tomatoes">
                </div>
                <div class="field">
                    <label>Crop Stage</label>
                    <select id="cropStage">
                        <option value="">‚Äî Select Stage ‚Äî</option>
                        <option value="Sowing">üå± Sowing (just planted)</option>
                        <option value="Vegetative">üåø Vegetative (growing)</option>
                        <option value="Flowering">üå∏ Flowering</option>
                        <option value="Fruiting">üçÖ Fruiting</option>
                        <option value="Harvest-Ready">üåæ Harvest Ready</option>
                    </select>
                </div>
                <div class="field">
                    <label>Farm Size</label>
                    <input type="text" id="farmSize" placeholder="e.g. 10 acres, 5 hectares">
                </div>
                <div class="field">
                    <label>Soil Type</label>
                    <select id="soilType">
                        <option value="">‚Äî Select Soil ‚Äî</option>
                        <option value="Clay">üè∫ Clay</option>
                        <option value="Sandy">üèúÔ∏è Sandy</option>
                        <option value="Loam">üåç Loam (best)</option>
                        <option value="Silt">üíß Silt</option>
                        <option value="Black">‚ö´ Black Cotton</option>
                        <option value="Red">üî¥ Red Laterite</option>
                    </select>
                </div>
                <div class="field">
                    <label>Irrigation Type</label>
                    <select id="irrigationType">
                        <option value="">‚Äî Select Method ‚Äî</option>
                        <option value="Drip">üíß Drip Irrigation</option>
                        <option value="Sprinkler">üåßÔ∏è Sprinkler</option>
                        <option value="Flood">üåä Flood / Canal</option>
                        <option value="Rain-fed">üå¶Ô∏è Rain-fed only</option>
                    </select>
                </div>
                <div class="field">
                    <label>Available Workers (people)</label>
                    <input type="number" id="availableLabor" placeholder="e.g. 5" min="0">
                </div>
                <div class="field full">
                    <label>Equipment Status</label>
                    <input type="text" id="equipmentStatus" placeholder="e.g. 1 tractor working, 1 pump needs repair">
                </div>
            </div>
        </div>
        <div class="nav-row">
            <button class="btn-next" onclick="goToStep(2)">Next: ML Scores ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 2 ‚Äî ML PREDICTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="wizard-panel" id="panel-2">
        <div class="card">
            <div class="card-title"><div class="icon">ü§ñ</div> AI Risk Scores</div>
            <p style="color:#78909c; margin-bottom:28px; font-size:0.93rem;">
                Move the sliders based on what your AI model predicted, or your gut feeling as a farmer.
            </p>

            <div class="slider-group">
                <div class="slider-label-row">
                    <div>
                        <div class="name">üë∑ Labor Demand</div>
                        <div style="font-size:0.78rem;color:#aaa;">How much worker help do you need?</div>
                    </div>
                    <span class="slider-badge badge-low" id="laborBadge">Low</span>
                </div>
                <input type="range" id="laborDemand" min="0" max="1" step="0.1" value="0.5"
                       oninput="updateSlider('laborDemand','laborBadge',this.value)">
                <div class="slider-hints"><span>üü¢ Very Low ‚Äî few workers needed</span><span>üî¥ Very High ‚Äî need many workers</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <div>
                        <div class="name">üíß Irrigation Urgency</div>
                        <div style="font-size:0.78rem;color:#aaa;">How dry is the soil right now?</div>
                    </div>
                    <span class="slider-badge badge-low" id="irrigationBadge">Low</span>
                </div>
                <input type="range" id="irrigationUrgency" min="0" max="1" step="0.1" value="0.5"
                       oninput="updateSlider('irrigationUrgency','irrigationBadge',this.value)">
                <div class="slider-hints"><span>üü¢ Soil is moist ‚Äî no rush</span><span>üî¥ Soil is very dry ‚Äî water NOW</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <div>
                        <div class="name">üöú Equipment Risk</div>
                        <div style="font-size:0.78rem;color:#aaa;">How likely is equipment to break down?</div>
                    </div>
                    <span class="slider-badge badge-low" id="equipmentBadge">Low</span>
                </div>
                <input type="range" id="equipmentRisk" min="0" max="1" step="0.1" value="0.5"
                       oninput="updateSlider('equipmentRisk','equipmentBadge',this.value)">
                <div class="slider-hints"><span>üü¢ All machines working fine</span><span>üî¥ Equipment may break soon</span></div>
            </div>
        </div>
        <div class="nav-row">
            <button class="btn-back" onclick="goToStep(1)">‚Üê Back</button>
            <button class="btn-next" onclick="goToStep(3)">Next: Weather ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 3 ‚Äî WEATHER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="wizard-panel" id="panel-3">
        <div class="card">
            <div class="weather-header">
                <div class="card-title" style="margin:0"><div class="icon">üå§Ô∏è</div> 7-Day Weather</div>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <div class="location-row">
                        <input type="text" id="locationInput" placeholder="Your city..." value="Delhi">
                        <button class="btn-fetch" onclick="fetchWeather()">
                            <span id="fetchIcon">üì°</span> Auto-Fill
                        </button>
                    </div>
                    <span class="fetch-status" id="fetchStatus">‚úÖ Weather loaded!</span>
                </div>
            </div>
            <p style="color:#90a4ae; font-size:0.85rem; margin-bottom:18px;">
                Click <b>Auto-Fill</b> to load real weather, or enter manually. Each column = one day.
            </p>
            <div class="weather-days" id="weatherGrid"></div>
        </div>
        <div class="nav-row">
            <button class="btn-back" onclick="goToStep(2)">‚Üê Back</button>
            <button class="btn-generate" onclick="generatePlan()">
                üöÄ Generate My Farm Plan!
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 4 ‚Äî RESULTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="wizard-panel" id="panel-4">

        <!-- Loading -->
        <div class="loading-screen" id="loadingScreen">
            <span class="field-anim">üåæ</span>
            <h3>Analysing your farm...</h3>
            <p>Our AI is building your personalised plan</p>
            <div class="progress-bar"><div class="progress-fill"></div></div>
        </div>

        <!-- Results -->
        <div class="results-panel" id="resultsPanel">

            <div class="farm-summary-card" id="farmSummaryCard"></div>

            <!-- ‚îÄ‚îÄ PROGRESS DASHBOARD ‚îÄ‚îÄ -->
            <div class="progress-dashboard" id="progressDashboard">
                <div class="progress-dashboard-title">üìä Task Completion Tracker Mark if Task is completed</div>

                <div class="progress-stats-row">
                    <div class="p-stat done-stat">
                        <div class="p-num" id="statDone">0</div>
                        <div class="p-label">‚úÖ Done</div>
                    </div>
                    <div class="p-stat pending-stat">
                        <div class="p-num" id="statPending">0</div>
                        <div class="p-label">‚è≥ Pending</div>
                    </div>
                    <div class="p-stat pct-stat">
                        <div class="p-num" id="statPct">0%</div>
                        <div class="p-label">üéØ Complete</div>
                    </div>
                </div>

                <!-- Overall progress bar -->
                <div class="overall-bar-wrap">
                    <div class="overall-bar-label">
                        <span>Overall Progress</span>
                        <span id="barPctLabel">0 / 0 tasks</span>
                    </div>
                    <div class="overall-bar-track">
                        <div class="overall-bar-fill" id="overallBarFill" style="width:0%">
                            <span id="overallBarText"></span>
                        </div>
                    </div>
                </div>

                <!-- Per-priority bars + donut -->
                <div class="chart-row">
                    <div class="donut-wrap">
                        <svg class="donut-svg" viewBox="0 0 100 100">
                            <circle class="donut-track" cx="50" cy="50" r="36"/>
                            <circle class="donut-fill" id="donutFill" cx="50" cy="50" r="36"
                                    stroke-dasharray="226.19"
                                    stroke-dashoffset="226.19"/>
                        </svg>
                        <div class="donut-text">
                            <div class="donut-pct" id="donutPct">0%</div>
                            <div class="donut-sub">complete</div>
                        </div>
                    </div>

                    <div style="flex:1; display:flex; flex-direction:column; gap:16px;">
                        <div class="category-bars" id="categoryBars">
                            <!-- Filled by JS -->
                        </div>
                        <div class="legend-list">
                            <div class="legend-item">
                                <div class="legend-dot done"></div>
                                <span class="legend-label">Completed</span>
                                <span class="legend-val" id="legendDone">0</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot pending"></div>
                                <span class="legend-label">Pending</span>
                                <span class="legend-val" id="legendPending">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <div class="result-section-title">‚ö° Today's Urgent Tasks</div>
                <div id="todayTasks"></div>
            </div>

            <div class="result-section">
                <div class="result-section-title">üìÖ This Week's Tasks</div>
                <div id="weeklyTasks"></div>
            </div>

            <button class="btn-export" id="exportBtn" onclick="exportPDF()">
                üìÑ Export as PDF
            </button>

            <button class="btn-reset" id="resetBtn" onclick="resetAll()">‚Ü© Start New Plan</button>
        </div>
    </div>

</div>

<script>
    let currentStep = 1;
    // Track completion state: key = "section-index", value = bool
    let taskCompletion = {};
    let allTasks = [];  // [{section, index, priority}]

    // ‚îÄ‚îÄ STEP NAVIGATION ‚îÄ‚îÄ
    function goToStep(step) {
        document.querySelectorAll('.wizard-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.step-item').forEach(t => t.classList.remove('active'));
        document.getElementById(`panel-${step}`).classList.add('active');
        document.getElementById(`step-tab-${step}`).classList.add('active');
        for (let i = 1; i < step; i++) {
            document.getElementById(`step-tab-${i}`).classList.add('done');
        }
        currentStep = step;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ‚îÄ‚îÄ SLIDERS ‚îÄ‚îÄ
    function updateSlider(sliderId, badgeId, value) {
        const badge = document.getElementById(badgeId);
        const v = parseFloat(value);
        if (v <= 0.3) {
            badge.textContent = 'Low';
            badge.className = 'slider-badge badge-low';
        } else if (v <= 0.6) {
            badge.textContent = 'Medium';
            badge.className = 'slider-badge badge-medium';
        } else {
            badge.textContent = 'High';
            badge.className = 'slider-badge badge-high';
        }
    }

    updateSlider('laborDemand',       'laborBadge',      0.5);
    updateSlider('irrigationUrgency', 'irrigationBadge', 0.5);
    updateSlider('equipmentRisk',     'equipmentBadge',  0.5);

    // ‚îÄ‚îÄ WEATHER GRID ‚îÄ‚îÄ
    const DAY_ICONS = ['‚òÄÔ∏è','‚õÖ','üå¶Ô∏è','üåßÔ∏è','üå§Ô∏è','‚õÖ','‚òÄÔ∏è'];
    const DAY_NAMES = ['Day 1','Day 2','Day 3','Day 4','Day 5','Day 6','Day 7'];

    function buildWeatherGrid(data) {
        const grid = document.getElementById('weatherGrid');
        grid.innerHTML = '';
        DAY_NAMES.forEach((day, i) => {
            const d = data ? data[i] : null;
            const rain  = d ? d.rainfall  : 0;
            const tmax  = d ? d.temp_max  : 30;
            const tmin  = d ? d.temp_min  : 20;
            const humid = d ? d.humidity  : 60;
            const icon  = rain > 15 ? 'üåßÔ∏è' : rain > 5 ? 'üå¶Ô∏è' : tmax > 38 ? 'üå°Ô∏è' : DAY_ICONS[i];
            grid.innerHTML += `
                <div class="w-day">
                    <div class="day-name">${day}</div>
                    <div class="w-icon">${icon}</div>
                    <div class="w-label">Rain mm</div>
                    <input type="number" id="rain${i}"    value="${rain}"  min="0" step="0.1">
                    <div class="w-label">Max ¬∞C</div>
                    <input type="number" id="tempMax${i}" value="${tmax}"  min="-10" max="55">
                    <div class="w-label">Min ¬∞C</div>
                    <input type="number" id="tempMin${i}" value="${tmin}"  min="-10" max="55">
                    <div class="w-label">Humidity %</div>
                    <input type="number" id="humidity${i}" value="${humid}" min="0" max="100">
                </div>`;
        });
    }

    buildWeatherGrid(null);

    async function fetchWeather() {
        const loc = document.getElementById('locationInput').value || 'Delhi';
        const btn = document.getElementById('fetchIcon');
        const status = document.getElementById('fetchStatus');
        btn.textContent = '‚è≥';
        status.classList.remove('show');
        try {
            const res  = await fetch(`/api/farm-weather?location=${encodeURIComponent(loc)}`);
            const data = await res.json();
            buildWeatherGrid(data.weather_forecast);
            status.textContent = `‚úÖ Weather loaded for ${data.location || loc}!`;
            status.classList.add('show');
        } catch(e) {
            status.textContent = '‚ö†Ô∏è Could not load ‚Äî using defaults';
            status.style.color = 'orange';
            status.classList.add('show');
        }
        btn.textContent = 'üì°';
    }

    // ‚îÄ‚îÄ COLLECT DATA ‚îÄ‚îÄ
    function collectData() {
        const farmInfo = {
            crop_type:        document.getElementById('cropType').value        || 'Unknown',
            crop_stage:       document.getElementById('cropStage').value       || 'Vegetative',
            farm_size:        document.getElementById('farmSize').value        || 'Unknown',
            soil_type:        document.getElementById('soilType').value        || 'Loam',
            irrigation_type:  document.getElementById('irrigationType').value  || 'Drip',
            available_labor:  parseInt(document.getElementById('availableLabor').value) || 3,
            equipment_status: document.getElementById('equipmentStatus').value || 'Operational',
        };
        const mlPredictions = {
            labor_demand:       parseFloat(document.getElementById('laborDemand').value),
            irrigation_urgency: parseFloat(document.getElementById('irrigationUrgency').value),
            equipment_risk:     parseFloat(document.getElementById('equipmentRisk').value),
        };
        const weatherData = [];
        for (let i = 0; i < 7; i++) {
            weatherData.push({
                day:      i,
                rainfall: parseFloat(document.getElementById(`rain${i}`).value)     || 0,
                temp_max: parseFloat(document.getElementById(`tempMax${i}`).value)  || 30,
                temp_min: parseFloat(document.getElementById(`tempMin${i}`).value)  || 20,
                humidity: parseFloat(document.getElementById(`humidity${i}`).value) || 60,
            });
        }
        return { farmInfo, mlPredictions, weatherData };
    }

    // ‚îÄ‚îÄ GENERATE PLAN ‚îÄ‚îÄ
    async function generatePlan() {
        goToStep(4);
        document.getElementById('loadingScreen').classList.add('show');
        document.getElementById('resultsPanel').classList.remove('show');
        taskCompletion = {};
        allTasks = [];

        const { farmInfo, mlPredictions, weatherData } = collectData();

        try {
            const res = await fetch('/get_farm_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ farm_info: farmInfo, ml_predictions: mlPredictions, weather_data: weatherData })
            });
            if (!res.ok) throw new Error('Server error');
            const data = await res.json();
            setTimeout(() => showResults(data), 800);
        } catch(e) {
            document.getElementById('loadingScreen').classList.remove('show');
            alert('‚ùå Error: ' + e.message + '\n\nMake sure Flask is running.');
        }
    }

    // ‚îÄ‚îÄ DISPLAY RESULTS ‚îÄ‚îÄ
    function showResults(data) {
        document.getElementById('loadingScreen').classList.remove('show');

        // Summary card
        const s = data.farm_summary;
        document.getElementById('farmSummaryCard').innerHTML = `
            <div class="summary-stat"><div class="s-label">üåæ Crop</div><div class="s-val">${s.crop || '‚Äî'}</div></div>
            <div class="summary-stat"><div class="s-label">üìã Stage</div><div class="s-val">${s.stage || '‚Äî'}</div></div>
            <div class="summary-stat"><div class="s-label">üìê Size</div><div class="s-val">${s.size || '‚Äî'}</div></div>
            <div class="summary-stat"><div class="s-label">‚ö° Today's Tasks</div><div class="s-val">${data.today_tasks.length}</div></div>
            <div class="summary-stat"><div class="s-label">üìÖ Weekly Tasks</div><div class="s-val">${data.weekly_tasks.length}</div></div>
            <div class="summary-stat"><div class="s-label">üïê Generated</div><div class="s-val" style="font-size:0.95rem">${data.generated_at}</div></div>
        `;

        // Register all tasks
        allTasks = [];
        data.today_tasks.forEach((t, i)  => allTasks.push({ section: 'today',  index: i, priority: t.priority.toLowerCase() }));
        data.weekly_tasks.forEach((t, i) => allTasks.push({ section: 'weekly', index: i, priority: t.priority.toLowerCase() }));
        allTasks.forEach(t => { taskCompletion[`${t.section}-${t.index}`] = false; });

        // Render today tasks
        const todayDiv = document.getElementById('todayTasks');
        todayDiv.innerHTML = data.today_tasks.length
            ? data.today_tasks.map((task, i) => taskCard(task, 'today', i)).join('')
            : '<div class="no-tasks">‚úÖ Great news! No urgent tasks for today.</div>';

        // Render weekly tasks
        const weeklyDiv = document.getElementById('weeklyTasks');
        weeklyDiv.innerHTML = data.weekly_tasks.length
            ? data.weekly_tasks.map((task, i) => taskCard(task, 'weekly', i)).join('')
            : '<div class="no-tasks">‚úÖ No additional tasks this week.</div>';

        // Build category bars placeholders
        renderCategoryBars();
        updateProgressDashboard();

        document.getElementById('resultsPanel').classList.add('show');
    }

    // ‚îÄ‚îÄ TASK CARD HTML (with checkbox) ‚îÄ‚îÄ
    function taskCard(task, section, index) {
        const p = task.priority.toLowerCase();
        const pillClass = `pill-${p}`;
        const key = `${section}-${index}`;
        return `
        <div class="task-card ${p}" id="card-${key}">
            <div class="task-top">
                <div class="task-checkbox-wrap">
                    <div class="task-checkbox" id="chk-${key}" onclick="toggleTask('${key}')" title="Mark as complete">
                        <span class="check-icon">‚úì</span>
                    </div>
                </div>
                <div class="task-name" id="name-${key}">${task.task_name}</div>
                <span class="priority-pill ${pillClass}">${task.priority}</span>
            </div>
            <div class="task-meta">
                <span>‚è∞ Deadline: <b>${task.deadline}</b></span>
            </div>
            <div class="task-reason">üìå ${task.reason}</div>
            <div class="task-risk">‚ö†Ô∏è <b>Risk if delayed:</b> ${task.risk_if_delayed}</div>
        </div>`;
    }

    // ‚îÄ‚îÄ TOGGLE TASK ‚îÄ‚îÄ
    function toggleTask(key) {
        taskCompletion[key] = !taskCompletion[key];
        const done = taskCompletion[key];

        const chk  = document.getElementById(`chk-${key}`);
        const card = document.getElementById(`card-${key}`);

        chk.classList.toggle('checked', done);
        card.classList.toggle('completed', done);

        if (done) spawnConfetti(chk);
        updateProgressDashboard();
    }

    // ‚îÄ‚îÄ CONFETTI BURST ‚îÄ‚îÄ
    function spawnConfetti(el) {
        const colors = ['#4caf50','#f5c842','#e67e22','#2980b9','#c0392b'];
        const rect = el.getBoundingClientRect();
        for (let i = 0; i < 12; i++) {
            const p = document.createElement('div');
            p.className = 'confetti-particle';
            p.style.left = (rect.left + rect.width/2 + (Math.random()-0.5)*60) + 'px';
            p.style.top  = (rect.top  + rect.height/2) + 'px';
            p.style.background = colors[Math.floor(Math.random()*colors.length)];
            p.style.transform = `rotate(${Math.random()*360}deg)`;
            p.style.animationDelay = (Math.random()*0.3) + 's';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1600);
        }
    }

    // ‚îÄ‚îÄ PROGRESS DASHBOARD UPDATE ‚îÄ‚îÄ
    function updateProgressDashboard() {
        const total  = allTasks.length;
        const done   = Object.values(taskCompletion).filter(Boolean).length;
        const pct    = total > 0 ? Math.round((done / total) * 100) : 0;
        const pending = total - done;

        // Stats
        document.getElementById('statDone').textContent    = done;
        document.getElementById('statPending').textContent = pending;
        document.getElementById('statPct').textContent     = pct + '%';
        document.getElementById('legendDone').textContent    = done;
        document.getElementById('legendPending').textContent = pending;

        // Overall bar
        document.getElementById('overallBarFill').style.width = pct + '%';
        document.getElementById('overallBarText').textContent  = pct > 10 ? pct + '%' : '';
        document.getElementById('barPctLabel').textContent     = `${done} / ${total} tasks`;

        // Donut chart
        const circumference = 226.19;
        const offset = circumference - (pct / 100) * circumference;
        document.getElementById('donutFill').style.strokeDashoffset = offset;
        document.getElementById('donutPct').textContent = pct + '%';

        // Per-priority bars
        renderCategoryBars();
    }

    // ‚îÄ‚îÄ CATEGORY BARS ‚îÄ‚îÄ
    function renderCategoryBars() {
        const cats = ['high','medium','low'];
        const labels = { high: 'üî¥ High', medium: 'üü† Medium', low: 'üîµ Low' };
        const fillClass = { high: 'fill-high', medium: 'fill-medium', low: 'fill-low' };

        let html = '';
        cats.forEach(cat => {
            const catTasks = allTasks.filter(t => t.priority === cat);
            if (catTasks.length === 0) return;
            const catDone = catTasks.filter(t => taskCompletion[`${t.section}-${t.index}`]).length;
            const catPct  = Math.round((catDone / catTasks.length) * 100);
            html += `
            <div class="cat-row">
                <div class="cat-label">${labels[cat]}</div>
                <div class="cat-track">
                    <div class="cat-fill ${fillClass[cat]}" style="width:${catPct}%"></div>
                </div>
                <div class="cat-count">${catDone}/${catTasks.length}</div>
            </div>`;
        });

        document.getElementById('categoryBars').innerHTML = html || '<div style="color:#aaa;font-size:0.85rem;">No tasks yet.</div>';
    }

    // ‚îÄ‚îÄ PDF EXPORT ‚îÄ‚îÄ
    function exportPDF() {
        const originalTitle = document.title;
        document.title = 'Farm-Action-Plan';
        document.getElementById('exportBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display  = 'none';
        window.print();
        document.getElementById('exportBtn').style.display = '';
        document.getElementById('resetBtn').style.display  = '';
        document.title = originalTitle;
    }

    function resetAll() {
        goToStep(1);
        document.querySelectorAll('.step-item').forEach(t => t.classList.remove('done'));
        document.getElementById('resultsPanel').classList.remove('show');
        taskCompletion = {};
        allTasks = [];
    }
</script>

{% endblock %}