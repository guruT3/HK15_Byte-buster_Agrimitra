{% extends "base.html" %}

{% block title %}Cold Storage | FarmCopilot{% endblock %}

{% block content %}

<style>
  body { background: #f0f7f0; }
  .hero { background: linear-gradient(135deg, #1a6b3a, #27ae60); color: white; padding: 40px 20px 60px; text-align: center; }
  .hero h1 { font-size: 2rem; font-weight: 700; }
  .tab-card { max-width: 720px; margin: -30px auto 30px; background: white; border-radius: 20px; box-shadow: 0 6px 28px rgba(0,0,0,0.10); overflow: hidden; }
  .nav-tabs .nav-link { color: #555; font-weight: 600; border: none; padding: 14px 24px; }
  .nav-tabs .nav-link.active { color: #1a6b3a; border-bottom: 3px solid #1a6b3a; background: none; }
  .tab-content { padding: 28px; }
  .section-label { font-size: 0.75rem; font-weight: 700; color: #888; letter-spacing: 1px; text-transform: uppercase; margin: 18px 0 8px; }
  .form-control { border-radius: 10px; border: 1px solid #cde8d4; padding: 10px 14px; }
  .form-control:focus { border-color: #27ae60; box-shadow: 0 0 0 3px rgba(39,174,96,0.15); }
  .input-group-text { border-radius: 10px 0 0 10px; background: #e9f7ef; border-color: #cde8d4; }
  .btn-green { background: #1a6b3a; color: white; border: none; border-radius: 25px; padding: 11px 32px; font-weight: 600; width: 100%; margin-top: 10px; }
  .btn-green:hover { background: #145a32; color: white; }
  .btn-whatsapp { background: #25D366; color: white; border: none; border-radius: 25px; padding: 11px 32px; font-weight: 600; width: 100%; margin-top: 8px; text-decoration: none; display: block; text-align: center; font-size: 1rem; cursor: pointer; }
  .btn-whatsapp:hover { background: #1ebe5d; color: white; }
  .whatsapp-note { background: #e8f8ee; border-left: 4px solid #25D366; padding: 10px 14px; border-radius: 8px; font-size: 0.85rem; color: #1a6b3a; margin-top: 12px; }
  .storage-section { max-width: 1100px; margin: 0 auto 40px; padding: 0 16px; }
  .storage-section h4 { color: #1a6b3a; font-weight: 700; margin-bottom: 18px; }
  .card-store { border: none; border-radius: 16px; box-shadow: 0 3px 14px rgba(0,0,0,0.08); transition: transform 0.2s; }
  .card-store:hover { transform: translateY(-4px); }
  .card-store .card-body { padding: 20px; }
  .meta { font-size: 0.84rem; color: #555; margin-bottom: 4px; }
  .meta i { color: #27ae60; width: 16px; }
  .badge-matched { background: #27ae60; }
  .badge-pending { background: #f39c12; }
  .badge-avail   { background: #27ae60; }
  .empty-state { text-align: center; padding: 40px 20px; color: #aaa; }
  label { font-weight: 500; font-size: 0.9rem; color: #333; }
</style>

<!-- Hero -->
<div class="hero">
  <h1><i class="fas fa-snowflake me-2"></i>Cold Storage Connect</h1>
  <p>List your facility or find nearby crop storage ‚Äî fast & easy</p>
</div>

<div class="container">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'success' if category == 'success' else 'info' if category == 'info' else 'danger' }} alert-dismissible fade show mt-3">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  {% endwith %}

  <!-- Forms Tabs -->
  <div class="tab-card">
    <ul class="nav nav-tabs px-3 pt-2">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ownerTab">
          <i class="fas fa-warehouse me-1"></i> List Storage
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#bookerTab">
          <i class="fas fa-box me-1"></i> Book Storage
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- OWNER FORM -->
      <div class="tab-pane fade show active" id="ownerTab">
        <form id="ownerForm" method="POST" action="{{ url_for('cold_storage_owner_add') }}">
          {{ owner_form.hidden_tag() }}

          <div class="section-label">üë§ Owner Info</div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ owner_form.owner_name.label(class="form-label") }}
              {{ owner_form.owner_name(class="form-control", placeholder="Full name", id="owner_name") }}
            </div>
            <div class="col-md-6">
              {{ owner_form.phone.label(class="form-label") }}
              {{ owner_form.phone(class="form-control", placeholder="+91 XXXXXXXXXX", id="owner_phone") }}
            </div>
          </div>

          <div class="section-label">üìç Location</div>
          <div class="row g-3">
            <div class="col-md-4">
              {{ owner_form.village.label(class="form-label") }}
              {{ owner_form.village(class="form-control", placeholder="Village", id="owner_village") }}
            </div>
            <div class="col-md-4">
              {{ owner_form.district.label(class="form-label") }}
              {{ owner_form.district(class="form-control", placeholder="District", id="owner_district") }}
            </div>
            <div class="col-md-4">
              {{ owner_form.state.label(class="form-label") }}
              {{ owner_form.state(class="form-control", placeholder="State", id="owner_state") }}
            </div>
          </div>

          <div class="section-label">üè≠ Storage Details</div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ owner_form.total_capacity_tons.label(class="form-label") }}
              {{ owner_form.total_capacity_tons(class="form-control", placeholder="e.g. 100", id="owner_total") }}
            </div>
            <div class="col-md-6">
              {{ owner_form.available_capacity_tons.label(class="form-label") }}
              {{ owner_form.available_capacity_tons(class="form-control", placeholder="e.g. 80", id="owner_available") }}
            </div>
            <div class="col-md-6">
              {{ owner_form.temperature_range.label(class="form-label") }}
              {{ owner_form.temperature_range(class="form-control", placeholder="2¬∞C ‚Äì 8¬∞C", id="owner_temp") }}
            </div>
            <div class="col-md-6">
              {{ owner_form.supported_crops.label(class="form-label") }}
              {{ owner_form.supported_crops(class="form-control", placeholder="Potato, Onion", id="owner_crops") }}
            </div>
            <div class="col-12">
              {{ owner_form.price_per_ton_per_month.label(class="form-label") }}
              <div class="input-group">
                <span class="input-group-text">‚Çπ</span>
                {{ owner_form.price_per_ton_per_month(class="form-control", placeholder="500", id="owner_price") }}
              </div>
            </div>
          </div>

          {{ owner_form.submit_owner(class="btn btn-green mt-3") }}
          <!-- <button type="button" class="btn-whatsapp" onclick="sendOwnerWhatsapp()">
            <i class="fab fa-whatsapp me-2"></i> Also Send via WhatsApp
          </button>
          <div class="whatsapp-note">
            üí° First click <strong>"List My Storage"</strong> to save ‚Üí then <strong>"Also Send via WhatsApp"</strong> to notify us.
          </div> -->
        </form>
      </div>

      <!-- BOOKER FORM -->
      <div class="tab-pane fade" id="bookerTab">
        <form id="bookerForm" method="POST" action="{{ url_for('cold_storage_book_add') }}">
          {{ booking_form.hidden_tag() }}

          <div class="section-label">üë§ Farmer Info</div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ booking_form.farmer_name.label(class="form-label") }}
              {{ booking_form.farmer_name(class="form-control", placeholder="Your full name", id="book_name") }}
            </div>
            <div class="col-md-6">
              {{ booking_form.phone.label(class="form-label") }}
              {{ booking_form.phone(class="form-control", placeholder="+91 XXXXXXXXXX", id="book_phone") }}
            </div>
          </div>

          <div class="section-label">üåæ Crop Details</div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ booking_form.crop_name.label(class="form-label") }}
              {{ booking_form.crop_name(class="form-control", placeholder="e.g. Potato", id="book_crop") }}
            </div>
            <div class="col-md-6">
              {{ booking_form.quantity_tons.label(class="form-label") }}
              {{ booking_form.quantity_tons(class="form-control", placeholder="e.g. 10", id="book_qty") }}
            </div>
          </div>

          <div class="section-label">üìç Preferred Location</div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ booking_form.preferred_village.label(class="form-label") }}
              {{ booking_form.preferred_village(class="form-control", placeholder="Village", id="book_village") }}
            </div>
            <div class="col-md-6">
              {{ booking_form.preferred_district.label(class="form-label") }}
              {{ booking_form.preferred_district(class="form-control", placeholder="District", id="book_district") }}
            </div>
          </div>

          <div class="section-label">üìÖ Storage Duration</div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ booking_form.storage_from.label(class="form-label") }}
              {{ booking_form.storage_from(class="form-control", id="book_from") }}
            </div>
            <div class="col-md-6">
              {{ booking_form.storage_until.label(class="form-label") }}
              {{ booking_form.storage_until(class="form-control", id="book_until") }}
            </div>
          </div>

          {{ booking_form.submit_booking(class="btn btn-green mt-3") }}
          <!-- <button type="button" class="btn-whatsapp" onclick="sendBookerWhatsapp()">
            <i class="fab fa-whatsapp me-2"></i> Also Send via WhatsApp
          </button> -->
          <!-- <div class="whatsapp-note">
            üí° First click <strong>"Book Storage"</strong> to save ‚Üí then <strong>"Also Send via WhatsApp"</strong> to notify us.
          </div> -->
        </form>
      </div>

    </div>
  </div>

  <!-- Available Storages -->
  <div class="storage-section">
    <h4><i class="fas fa-map-marker-alt me-2"></i>Available Cold Storages</h4>
    {% if storages %}
    <div class="row g-3">
      {% for s in storages %}
      <div class="col-md-4">
        <div class="card card-store h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h6 class="fw-bold mb-0">{{ s.owner_name }}</h6>
              <span class="badge badge-avail text-white">Available</span>
            </div>
            <p class="meta"><i class="fas fa-map-marker-alt"></i> {{ s.village }}, {{ s.district }}</p>
            <p class="meta"><i class="fas fa-weight-hanging"></i> {{ s.available_capacity_tons }} / {{ s.total_capacity_tons }} tons</p>
            <p class="meta"><i class="fas fa-thermometer-half"></i> {{ s.temperature_range }}</p>
            <p class="meta"><i class="fas fa-seedling"></i> {{ s.supported_crops }}</p>
            <p class="meta"><i class="fas fa-rupee-sign"></i> ‚Çπ{{ s.price_per_ton_per_month }} / ton / month</p>
            <p class="meta"><i class="fas fa-phone"></i> {{ s.phone }}</p>
            {% if s.user_id == session.get('user_id') %}
            <a href="{{ url_for('toggle_cold_storage', owner_id=s.id) }}" class="btn btn-sm btn-outline-danger w-100 mt-2">Toggle Availability</a>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <i class="fas fa-snowflake fa-3x d-block mb-2"></i>
      <p>No storage listed yet. Be the first!</p>
    </div>
    {% endif %}

    <!-- My Bookings -->
    {% if bookings %}
    <h4 class="mt-5"><i class="fas fa-clipboard-list me-2"></i>My Bookings</h4>
    <div class="row g-3">
      {% for b in bookings %}
      <div class="col-md-4">
        <div class="card card-store h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h6 class="fw-bold mb-0">{{ b.crop_name }}</h6>
              <span class="badge text-white {{ 'badge-matched' if b.status == 'matched' else 'badge-pending' }}">
                {{ b.status | capitalize }}
              </span>
            </div>
            <p class="meta"><i class="fas fa-weight-hanging"></i> {{ b.quantity_tons }} tons</p>
            <p class="meta"><i class="fas fa-map-marker-alt"></i> {{ b.preferred_village }}, {{ b.preferred_district }}</p>
            <p class="meta"><i class="fas fa-calendar-alt"></i> {{ b.storage_from }} ‚Üí {{ b.storage_until }}</p>
            <p class="meta"><i class="fas fa-phone"></i> {{ b.phone }}</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const WA_NUMBER = "917846917002";

  function sendOwnerWhatsapp() {
    const name      = document.getElementById('owner_name').value.trim();
    const phone     = document.getElementById('owner_phone').value.trim();
    const village   = document.getElementById('owner_village').value.trim();
    const district  = document.getElementById('owner_district').value.trim();
    const state     = document.getElementById('owner_state').value.trim();
    const total     = document.getElementById('owner_total').value.trim();
    const available = document.getElementById('owner_available').value.trim();
    const temp      = document.getElementById('owner_temp').value.trim();
    const crops     = document.getElementById('owner_crops').value.trim();
    const price     = document.getElementById('owner_price').value.trim();

    if (!name || !phone || !village || !district) {
      alert("Please fill Name, Phone, Village and District first.");
      return;
    }

    const msg =
`üè≠ *New Cold Storage Listing*

üë§ Owner: ${name}
üìû Phone: ${phone}
üìç Location: ${village}, ${district}, ${state}

üì¶ Total Capacity: ${total} tons
‚úÖ Available: ${available} tons
üå° Temperature: ${temp}
üåæ Crops: ${crops}
üí∞ Price: ‚Çπ${price} / ton / month

_Via FarmCopilot Cold Storage_`;

    window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
  }

  function sendBookerWhatsapp() {
    const name     = document.getElementById('book_name').value.trim();
    const phone    = document.getElementById('book_phone').value.trim();
    const crop     = document.getElementById('book_crop').value.trim();
    const qty      = document.getElementById('book_qty').value.trim();
    const village  = document.getElementById('book_village').value.trim();
    const district = document.getElementById('book_district').value.trim();
    const from     = document.getElementById('book_from').value.trim();
    const until    = document.getElementById('book_until').value.trim();

    if (!name || !phone || !crop || !village) {
      alert("Please fill Name, Phone, Crop and Village first.");
      return;
    }

    const msg =
`üì¶ *Cold Storage Booking Request*

üë§ Farmer: ${name}
üìû Phone: ${phone}
üåæ Crop: ${crop}
‚öñ Quantity: ${qty} tons
üìç Preferred: ${village}, ${district}
üìÖ Duration: ${from} ‚Üí ${until}

_Via FarmCopilot Cold Storage_`;

    window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
  }
</script>
{% endblock %}